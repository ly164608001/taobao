<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lxhrainy.myjz.admin.order.dao.IOrderInfoDao">
    
	<sql id="orderInfoColumns">
		T.id AS "id",
		T.orderno AS "orderno",
		T.createtime AS "createtime",
		T.createuser AS "createuser.id",
		T.publictime AS "publictime",
		T.istime AS "istime",
		T.status AS "status",
		T.bond AS "bond",
		T.receiveruser AS "receiveruser.id",
		T.receivetime AS "receivetime",
		T.shopid AS "shop.id",
		T.searchroad AS "searchroad",
		T.type AS "type",
		T.paytime AS "paytime",
		
		RU.loginip AS "receiveruser.loginip",
		RU.creditscore AS "receiveruser.creditscore",
		RU.username AS "receiveruser.username",
		
		S.name AS "shop.name"
	</sql>
	
	<sql id="orderInfoJoins">
		LEFT JOIN USER_INFO CU ON CU.id = T.createuser 
		LEFT JOIN USER_INFO RU ON RU.id = T.receiveruser 
		LEFT JOIN seller_shop S ON S.id = T.shopid
	</sql>
    
    <sql id="where">
		<if test="condition!=null">
			<where>
				1 = 1
				<if test="condition.publicBegin != null">
					AND T.publictime &gt;= #{condition.publicEnd}
				</if>
				<if test="condition.publicEnd != null">
					AND T.publictime &lt;= #{condition.publicEnd}
				</if>
				<if test="condition.model!=null">
					<if test="condition.model.orderno != null and condition.model.orderno != ''">
						AND T.orderno LIKE CONCAT('%',#{condition.model.orderno},'%') 
					</if>
				</if>
			</where>
		</if>
	</sql>
	
	<select id="getById" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM order_info T
		<include refid="orderInfoJoins"/>
		WHERE T.id = #{id}
	</select>
	
	<select id="findListByPage" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM order_info T
		<include refid="orderInfoJoins"/>
		<include refid="where"/>
		order by T.ID DESC
			<include refid="Sql.pager" />
	</select>
	
	<select id="findAllList" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM order_info T
		<include refid="orderInfoJoins"/>
		<include refid="where"/>
	</select>
	
	<select id="getCountByCondition" resultType="int">
		SELECT 
			COUNT(1)
		FROM order_info T
		<include refid="orderInfoJoins"/>
		<include refid="where"/>
	</select>
	
	<insert id="insert">
		INSERT INTO order_info(
			id,
			orderno,
			createtime,
			createuser,
			publictime,
			istime,
			status,
			bond,
			receiveruser,
			receivetime,
			shopid,
			searchroad,
			type,
			paytime
		) VALUES (
			#{id},
			#{orderno},
			#{createtime},
			#{createuser.id},
			#{publictime},
			#{istime},
			#{status},
			#{bond},
			#{receiveruser.id},
			#{receivetime},
			#{shop.id},
			#{searchroad},
			#{type},
			#{paytime}
		)
	</insert>
	
	<update id="update">
		UPDATE order_info SET 	
			orderno = #{orderno},
			createtime = #{createtime},
			createuser = #{createuser.id},
			publictime = #{publictime},
			istime = #{istime},
			status = #{status},
			bond = #{bond},
			receiveruser = #{receiveruser.id},
			receivetime = #{receivetime},
			shopid = #{shop.id},
			searchroad = #{searchroad},
			type = #{type},
			paytime = #{paytime}
		WHERE id = #{id}
	</update>
	
	<update id="deleteById">
		DELETE FROM order_info
		WHERE id = #{id}
	</update>
	
	<select id="getListForMobile" resultType="OrderInfo">
		SELECT 
			<include refid="orderInfoColumns"/>
		FROM sys_notice T
			<include refid="orderInfoJoins"/>
		<if test="condition!=null">
			<where>
				<if test="condition.model != null">
					<if test="condition.model.user != null">
						<if test="condition.model.user.id != null">
							AND T.userid = #{condition.model.user.id}
						</if>
					</if>
				</if>
				<if test="condition.offsetid != null">
					AND T.id &lt; #{condition.offsetid}
				</if>
			</where>
		order by T.id desc
		limit 0,${condition.count}
		</if>
	</select>
	
	<select id="statisticsTask" resultType="TaskStatistics">
		SELECT 
			count(T.id) AS "number",
			T.type AS "targetplatfrom",
			T.targetsubtype AS "targetsubtype"
		FROM order_info T
		where T.receiveruser = #{user.id}
		GROUP BY T.type,T.targetsubtype
	</select>
	
</mapper>