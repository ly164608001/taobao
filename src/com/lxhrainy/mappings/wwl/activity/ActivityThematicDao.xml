<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lxhrainy.myjz.admin.activity.dao.IActivityThematicDao">
    
   
	
	<sql id="activityThematicColumns">
		T.id AS "id",
		T.housesid AS "house.id",
		house.name AS "house.name",
		house.detailaddress AS "house.detailaddress",
		house.price AS "house.price",
		T. name AS "name",
		T.starttime AS "starttime",
		T.endtime AS "endtime",
		T.createuser AS "createuser.id",
		user.username AS "user.username",
		T.createtime AS "createtime",
		T.type AS "type",
		T.applytimes AS "applytimes",
		T.applytimee AS "applytimee",
		T.address AS "address",
		T.personnum AS "personnum",
		T.activitycontent AS "activitycontent",
		T.status AS "status",
		T.applynum AS "applynum",
		T.deleted AS "deleted"
	</sql>
	
    
	<sql id="activityThematicJoins">
	left JOIN user_info user ON user.id = T.createuser
	left JOIN houses_info house ON house.id = T.housesid
	</sql>
    
	<select id="getById" resultType="ActivityThematic">
		SELECT 
			<include refid="activityThematicColumns"/>
		FROM activity_thematic T
		<include refid="activityThematicJoins"/>
		WHERE T.id = #{id}
	</select>
	
	<select id="findListByPage" resultType="ActivityThematic">
		SELECT 
			<include refid="activityThematicColumns"/>
		FROM activity_thematic T
		<include refid="activityThematicJoins"/>
		<if test="condition!=null">
			<where>
				T.deleted=0
				<if test="condition.type!=null and condition.type!=''">
						AND T.type = '${condition.model.type}'
				</if>
				<if test="condition.model!=null">
					<if test="condition.model.name!=null and condition.model.name!=''">
						 AND T.name LIKE '%${condition.model.name}%'
					</if>
				</if>
			</where>
			order by T.ID DESC
			<include refid="Sql.pager" />
		</if>
	</select>
	<select id="getCountByCondition" resultType="int">
		SELECT 
			count(*)
		FROM activity_thematic T
		<include refid="activityThematicJoins"/>
		<if test="condition!=null">
			<where>
				T.deleted=0
				<if test="condition.type!=null and condition.type!=''">
						AND T.type = '${condition.model.type}'
				</if>
				<if test="condition.model!=null">
					<if test="condition.model.name!=null and condition.model.name!=''">
						 AND T.name LIKE '%${condition.model.name}%'
					</if>
				</if>
			</where>
		</if>
	</select>
	
	<select id="findAllList" resultType="ActivityThematic">
		SELECT 
			<include refid="activityThematicColumns"/>
		FROM activity_thematic T
		<include refid="activityThematicJoins"/>
		<where>
			T.deleted=0
			<if test="condition.type!=null and condition.type!=''">
				AND T.type = '${condition.model.type}'
			</if>
			<if test="condition.model!=null">
				<if test="condition.model.name!=null and condition.model.name!=''">
					 AND T.name LIKE '%${condition.model.name}%'
				</if>
			</if>
		</where>		
	</select>
	
	<select id="getCountActivityByUserid" resultType="int">
	SELECT 
			count(*)
		FROM activity_thematic T
		LEFT JOIN user_info user ON T.createuser=user.id
		LEFT JOIN activity_thematic_user atu ON T.id=atu.activityid
		LEFT JOIN houses_info house ON house.id=T.housesid
		<where>
			T.deleted=0 AND atu.deleted=0 AND house.deleted=0
			<if test="condition!=null">
				<if test="condition.userid!=null and condition.userid!=''">
					AND	atu.userid=#{condition.userid}
				</if>
				<if test="condition.createtime_start!=null and condition.createtime_start!=''">
					AND	T.starttime &gt; #{condition.createtime_start}
				</if>
				<if test="condition.createtime_end!=null and condition.createtime_end!=''">
					AND	T.starttime &lt; #{condition.createtime_end}
				</if>
				<if test="condition.type!=null and condition.type!=''"> 
					AND  T.type=#{condition.type} 
				</if>
				<if test="condition.status!=null"> 
					AND  atu.status=#{condition.status} 
				</if>
			</if>
		</where>	
	</select>
		
	
	<select id="showActivityByUserid" resultType="ActivityThematic">
		SELECT 
			T.name AS "name",
			user.phone AS "createuser.phone",
			T.activitycontent AS "activitycontent",
			T.starttime AS "starttime",
			T.address AS "address",
			atu.applytime AS "atUser.applytime",
			atu.id AS "atUser.id",
			atu.status AS "atUser.status",
			house.id AS "house.id",
			house.name AS "house.name",
			house.detailaddress AS "house.detailaddress",
			house.price AS "house.price",
			house.housespic AS "house.housespic"
			FROM activity_thematic T
		LEFT JOIN user_info user ON T.createuser=user.id
		LEFT JOIN activity_thematic_user atu ON T.id=atu.activityid
		LEFT JOIN houses_info house ON house.id=T.housesid
		<where>
			T.deleted=0 AND atu.deleted=0 AND house.deleted=0
			<if test="condition!=null">
				<if test="condition.userid!=null and condition.userid!=''">
					AND	atu.userid=#{condition.userid}
				</if>
				<if test="condition.createtime_start!=null and condition.createtime_start!=''">
					AND	atu.applytime &gt; #{condition.createtime_start}
				</if>
				<if test="condition.createtime_end!=null and condition.createtime_end!=''">
					AND	atu.applytime &lt; #{condition.createtime_end}
				</if>
				<if test="condition.type!=null and condition.type!=''"> 
					AND  T.type=#{condition.type} 
				</if>
				<if test="condition.status!=null"> 
					AND  atu.status=#{condition.status} 
				</if>
			</if>
		</where>
		<include refid="Sql.pager" />		
	</select>
	
	
	<insert id="insert">
	INSERT INTO activity_thematic (
	id,
	housesid,
	name,
	starttime,
	endtime,
	createuser,
	createtime,
	type,
	applytimes,
	applytimee,
	address,
	personnum,
	activitycontent,
	status,
	applynum,
	deleted
	)values (
	#{id},
	#{house.id},
	#{name},
	#{starttime},
	#{endtime},
	#{createuser.id},
	#{createtime},
	#{type},
	#{applytimes},
	#{applytimee},
	#{address},
	#{personnum},
	#{activitycontent},
	#{status},
	#{applynum},
	#{deleted}
	)
		<!-- 配置Mysql主键自动增长 -->
		<selectKey resultType="int" keyProperty="id">
			select
			LAST_INSERT_ID() as value  
		</selectKey>
	</insert>
		
	 <update id="update" >
    update activity_thematic
    <set >
      <if test="house.id != null" >
        housesid = #{house.id},
      </if>
      <if test="name != null" >
        name = #{name},
      </if>
      <if test="starttime != null" >
        starttime = #{starttime},
      </if>
      <if test="endtime != null" >
        endtime = #{endtime},
      </if>
      <if test="createuser != null" >
        createuser = #{createuser.id},
      </if>
      <if test="createtime != null" >
        createtime = #{createtime},
      </if>
      <if test="type != null" >
        type = #{type},
      </if>
      <if test="applytimes != null" >
        applytimes = #{applytimes},
      </if>
      <if test="applytimee != null" >
        applytimee = #{applytimee},
      </if>
      <if test="address != null" >
        address = #{address},
      </if>
      <if test="personnum != null" >
        personnum = #{personnum},
      </if>
      <if test="activitycontent != null" >
        activitycontent = #{activitycontent},
      </if>
      <if test="status != null" >
        status = #{status},
      </if>
      <if test="applynum != null" >
        applynum = #{applynum},
      </if>
      <if test="deleted != null" >
        deleted = #{deleted},
      </if>
    </set>
    where id = #{id}
  </update>
	
	<update id="deleteById">
		update activity_thematic set 
			deleted=1
		WHERE id = #{id}
	</update>
	<update id="updateStatus">
		update activity_thematic set status = #{status}
		WHERE id = #{id}
	</update>
</mapper>