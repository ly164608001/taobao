<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lxhrainy.myjz.admin.interaction.dao.IInteractionBrowerHistoryDao">
    
	
	<sql id="interactionBrowerHistoryColumns">
		T.id AS "id",
		T.userid AS "user.id",
		user.username AS "user.username",
		T.houseid AS "house.id",
		house.name AS "house.name",
		house.housespic AS "house.housespic",
		house.detailaddress AS "house.detailaddress",
		house.price AS "house.price",
		T.browertime AS "browertime",
		T.deleted AS "deleted"
	</sql>
    
	<sql id="interactionBrowerHistoryJoins">
	left JOIN user_info user ON user.id = T.userid
	left JOIN houses_info house ON house.id =T.houseid
	</sql>
	
	<sql id="where">
			<if test="condition!=null">
				<where>
					<if test="condition.userid!=null">
					 	AND T.userid='${condition.userid}'
					</if>
					<if test="condition.createtime_start!=null and condition.createtime_start!=''">
					AND T.browertime &gt;'${condition.createtime_start}'
					</if>
					<if test="condition.createtime_end!=null and condition.createtime_end!=''">
						AND T.browertime &lt;'${condition.createtime_end}'
					</if>
					<if test="condition.model!=null">
						<if test="condition.model.deleted!=null">
							AND T.deleted = #{condition.model.deleted}
						</if>
						<if test="condition.model.user!=null and condition.model.user!=''">
							AND user.username LIKE '${condition.model.user.username}%'
						</if>
					</if>
				</where>
			</if>
		</sql>
	
	
    
	<select id="getById" resultType="InteractionBrowerHistory">
		SELECT 
			<include refid="interactionBrowerHistoryColumns"/>
		FROM interaction_brower_history T
		<include refid="interactionBrowerHistoryJoins"/>
		WHERE T.id = #{id}
	</select>
	
	<select id="findListByPage" resultType="InteractionBrowerHistory">
		SELECT 
			<include refid="interactionBrowerHistoryColumns"/>
		FROM interaction_brower_history T
		<include refid="interactionBrowerHistoryJoins"/>
		<include refid="where"/>
	</select>
	
	
	<select id="getCountByCondition" resultType="int">
		SELECT 
			count(*)
		FROM interaction_brower_history T
		<include refid="interactionBrowerHistoryJoins"/>
		<include refid="where"/>
	</select>
	
	<select id="findAllList" resultType="InteractionBrowerHistory">
		SELECT 
			<include refid="interactionBrowerHistoryColumns"/>
		FROM interaction_brower_history T
		<include refid="interactionBrowerHistoryJoins"/>
		<include refid="where"/>
	</select>
	
	<select id="getCountByTimeGroup" resultType="int">
		SELECT 
			count(*)
		FROM( SELECT
			DATE_FORMAT(browertime,'%Y-%m-%d') as "browertime"
		FROM interaction_brower_history T
		<where>
				T.deleted=0
			<if test="condition!=null">	
				<if test="condition.userid!=null and condition.userid!=''">
					AND T.userid=${condition.userid}
				</if>
				<if test="condition.createtime_start!=null and condition.createtime_start!=''">
					AND T.browertime &gt;'${condition.createtime_start}'
				</if>
				<if test="condition.createtime_end!=null and condition.createtime_end!=''">
					AND T.browertime &lt;'${condition.createtime_end}'
				</if>
			</if>
		</where>
		GROUP BY DATE_FORMAT(T.browertime,'%Y-%m-%d')
		) AS c
	</select>
	
	<select id="getTimeGroup" resultType="MyTracksInfo">
		SELECT 
			DATE_FORMAT(browertime,'%Y-%m-%d') as "browertime"
		FROM interaction_brower_history T
		<where>
				T.deleted=0
			<if test="condition!=null">	
				<if test="condition.userid!=null and condition.userid!=''">
					AND T.userid=${condition.userid}
				</if>
				<if test="condition.createtime_start!=null and condition.createtime_start!=''">
					AND T.browertime &gt;'${condition.createtime_start}'
				</if>
				<if test="condition.createtime_end!=null and condition.createtime_end!=''">
					AND T.browertime &lt;'${condition.createtime_end}'
				</if>
			</if>
		</where>
		GROUP BY DATE_FORMAT(T.browertime,'%Y-%m-%d')
		ORDER BY id DESC	
		<include refid="Sql.pager" />
	</select>
	
	<insert id="insert">
		INSERT INTO interaction_brower_history(
			id, 
			userid,
			houseid,
			browertime,
			deleted
			
		) VALUES (
			#{id}, 
			#{user.id},
			#{house.id},
			#{browertime},
			#{deleted}
		)
		<!-- 配置Mysql主键自动增长 -->
		<selectKey resultType="int" keyProperty="id">
			select
			LAST_INSERT_ID() as value  
		</selectKey>
	</insert>
	
	<update id="update">
		UPDATE interaction_brower_history
		<set>
			<if test="userid!=null">
				userid = #{user.id},
			</if>
			<if test="houseid!=null">
				houseid = #{house.id},
			</if>
			<if test="browertime!=null">
				browertime = #{browertime},
			</if>
			<if test="deleted != null">
				deleted = #{deleted}
			</if>
		</set>
		WHERE id = #{id}
	</update>
	
	<update id="deleteById">
		update interaction_brower_history set 
			deleted=1
		WHERE id = #{id}
	</update>
	
</mapper>