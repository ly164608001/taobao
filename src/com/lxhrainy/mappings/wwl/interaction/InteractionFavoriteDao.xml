<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lxhrainy.myjz.admin.interaction.dao.IInteractionFavoriteDao">
    
    <resultMap id="InteractionFavorite" type="com.lxhrainy.myjz.admin.interaction.model.InteractionFavorite">
		<id property="id" column="id" />
		<result property="user.id" column="user.id" />
		<result property="user.username" column="user.username" />
		<result property="housename.id" column="housename.id" />
		<result property="housename.name" column="housename.name" />
		<result property="housename.housespic" column="housename.housespic" />
		<result property="favoritetime" column="favoritetime" />
		<result property="orderValue" column="orderValue" />
		<result property="housestype.id" column="housestype.id" />
		
	</resultMap>
	
	<sql id="interactionFavoriteColumns">
		T.id AS "id",
		T.userid AS "user.id",
		T.housesid AS "housename.id",
		T.favoritetime AS "favoritetime",
		user.username AS "user.username",
		housename.name AS "housename.name",
		housename.housespic AS "housename.housespic",
		T.orderValue AS "orderValue",
		T.housestypeid AS "housestype.id",
		type. name AS"housestype.name",
		type.typepic AS "housestype.typepic",
		type.roomNum AS "housestype.roomNum",
		type.toiletnum AS "housestype.toiletnum",
		type.balconynum AS "housestype.balconynum",
		type.hallnum AS "housestype.hallnum",
		type.buildarea AS "housestype.buildarea" 
	</sql>
	
    
	<sql id="interactionFavoriteJoins">

	Left JOIN user_info user ON user.id = T.userid
	Left JOIN houses_info housename ON housename.id = T.housesid
	LEFT JOIN houses_type type ON type.id = T.housestypeid
	</sql>
	<!-- 用户收藏户型 --> 
	<select id="getHousetype" resultType="HousesType">
	SELECT
		T.id AS "id",
		type. NAME ,
		type.typepic ,
		type.roomNum ,
		type.toiletnum ,
		type.balconynum ,
		type.hallnum ,
		type.buildarea  
	FROM
	interaction_favorite T
	LEFT JOIN houses_type type ON type.id = T.housestypeid
	<where>
		<if test="houseid!=null and houseid!=''">
			 T.housesid = #{houseid}
		</if>
		<if test="userid!=null and userid!=''">
			AND T.userid = #{userid}
		</if>
	</where>
	order by T.ID DESC
	</select> 
    
	<select id="getById" resultType="InteractionFavorite">
		SELECT 
			<include refid="interactionFavoriteColumns"/>
		FROM interaction_favorite T
		<include refid="interactionFavoriteJoins"/>
		WHERE T.id = #{id} 
	</select>
	
	<select id="findListByPage" resultMap="InteractionFavorite">
		SELECT 
			<include refid="interactionFavoriteColumns"/>
		FROM interaction_favorite T
		<include refid="interactionFavoriteJoins"/>
		<if test="condition!=null">
			<where>
				T.deleted=0
				<if test="condition.userid!=null">
				 AND userid='${condition.userid}'
				</if>
				<if test="condition.model!=null">
					<if test="condition.model.user.username!=null and condition.model.user.username!=''">
						AND user.username LIKE '${condition.model.user.username}%'
					</if>
					<if test="condition.model.user.id!=null and condition.model.user.id!=''">
						AND user.id='${condition.model.user.id}'
					</if>
					<if test="condition.model.housename.name!=null and condition.model.housename.name!=''">
						AND housename.name like '%${condition.model.housename.name}%'
					</if>
				</if>
			</where>
			GROUP BY housename.id
			order by T.ID DESC
			<include refid="Sql.pager" />
		</if>
	</select>
	
	<select id="getCountByCondition" resultType="int">
		SELECT 
			count(*)
		FROM
		( SELECT 
		<include refid="interactionFavoriteColumns"/>
		FROM
			interaction_favorite T
		<include refid="interactionFavoriteJoins"/>
			<where>
				T.deleted=0
				<if test="condition!=null">
					<if test="condition.userid!=null">
					 	AND userid='${condition.userid}'
					</if>
					<if test="condition.model!=null">
						<if test="condition.model.user.username!=null and condition.model.user.username!=''">
							AND user.username LIKE '${condition.model.user.username}%'
						</if>
						<if test="condition.model.user.id!=null and condition.model.user.id!=''">
							AND user.id='${condition.model.user.id}'
						</if>
						<if test="condition.model.housename.name!=null and condition.model.housename.name!=''">
							AND housename.name like '%${condition.model.housename.name}%'
						</if>
					</if>
				</if>
			</where>
			GROUP BY housename.id ) AS C
	</select>
	
	<select id="findAllList" resultType="InteractionFavorite">
		SELECT 
			<include refid="interactionFavoriteColumns"/>
		FROM interaction_favorite T
		<include refid="interactionFavoriteJoins"/>
		<where>
			T.deleted=0
			<if test="condition.userid!=null">
				 AND userid='${condition.userid}'
			</if>
			<if test="condition!=null">
				<if test="condition.model!=null">
					<if test="condition.model.user.username!=null and condition.model.user.username!=''">
						AND user.username LIKE '${condition.model.user.username}%'
					</if>
					<if test="condition.model.user.id!=null and condition.model.user.id!=''">
						AND user.id='${condition.model.user.id}'
					</if>
					<if test="condition.model.housename.name!=null and condition.model.housename.name!=''">
						AND housename.name like '%${condition.model.housename.name}%'
					</if>
				</if>
			</if>
		</where>		
	</select>
	<!-- 楼盘下所有户型 -->
	<select id="getAllTypeByHouseid" resultType="HousesType">
		SELECT DISTINCT  
		type.name,
		type.roomnum,
		type.toiletnum,
		type.hallnum,
		type.balconynum ,
		type.buildarea,
		type.typepic
		
		FROM interaction_favorite T
		
		LEFT JOIN houses_building b ON b.housesid=T.housesid
		LEFT JOIN houses_source s on  s.buildingid=b.id
		LEFT JOIN houses_type type ON s.housetypeid=type.id
		
		WHERE type.deleted=0 AND T.deleted=0 AND b.deleted=0 AND s.deleted=0 
		<if test="houseid!=null">
		 	AND  T.housesid=#{houseid}
		</if>
	</select>
	
	<select id="getRushSaleByHouseid" resultType="RushSaleInfo">
	SELECT
		type.name	AS "houseType.name",
		type.roomnum AS "houseType.roomnum",
		type.toiletnum AS "houseType.toiletnum",
		type.hallnum AS "houseType.hallnum",
		type.balconynum AS "houseType.balconynum",
		type.buildarea AS "houseType.buildarea",
		type.typepic AS "houseType.typepic",
		b.name AS "building.name",
		s.floornum AS "building.floornum",
		s.unit AS "source.unit",
		s.towards AS "source.towards",
		type.floorheight AS "houseType.floorheight",
		s.unitprice AS "source.unitprice",
		s.totalprice AS "source.totalprice",
		rh.price AS "rush.price",
		rh.price * s.buildarea AS "rushtotalprice"
	FROM
		interaction_favorite f
	LEFT JOIN activity_rush r ON r.housesid = f.housesid
	LEFT JOIN activity_rush_houses rh ON rh.rushid = r.id
	LEFT JOIN houses_source s ON s.id = rh.sourceid
	LEFT JOIN houses_type type ON s.housetypeid = type.id
	LEFT JOIN houses_building b ON b.id = s.buildingid
	<where>
		f.deleted = 0 AND r.deleted = 0 AND s.deleted = 0 AND type.deleted = 0
		<if test="houseid!=null">
			AND f.housesid =#{houseid}
		</if>
		<if test="date!=null">
			AND r.starttime &lt; #{date} AND r.endtime &gt; #{date}
		</if>
	</where>
	</select>
	
	<insert id="insert">
		INSERT INTO interaction_favorite(
			userid,
			housesid,
			favoritetime,
			orderValue,
			housestypeids,
			deleted
		) VALUES (
			#{user.id},
			#{housename.id},
			#{favoritetime},
			#{orderValue},
			#{housestypeid},
			#{deleted}
			
		)
		<!-- 配置Mysql主键自动增长 -->
		<selectKey resultType="int" keyProperty="id">
			select
			LAST_INSERT_ID() as value  
		</selectKey>
	</insert>
	
	<update id="update">
		UPDATE interaction_favorite
		<set>
			<if test="id!=null">
				id = #{id},
			</if>
			<if test="user!=null and user.id!=null">
				userid = #{user.id},
			</if>
			<if test="housesid != null">
				housesid = #{housesname.id},
			</if>
			<if test="favoritetime != null">
				favoritetime = #{favoritetime},
			</if>
			<if test="orderValue != null">
				orderValue = #{orderValue},
			</if>
			<if test="housestypeid != null">
				housestypeid = #{housestypeid},
			</if>
		</set>
		WHERE id = #{id}
	</update>
	
	<update id="deleteByHouse">
		update interaction_favorite set 
			deleted=1
		<where>
			<if test="condition.userid!=null">
				userid='${condition.userid}'
			</if>
			<if test="condition.houseid!=null">
				AND housesid='${condition.houseid}'
			</if>
		</where>
	</update>
	
	<update id="deleteById">
		update interaction_favorite set 
			deleted=1
		WHERE id = #{id}
	</update>
</mapper>