<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lxhrainy.myjz.admin.interaction.dao.IInteractionAppraiseRecordDao">
    
	<resultMap id="appraiseReply" type="com.lxhrainy.myjz.admin.interaction.model.InteractionAppraiseRecord" >
		<id property="id"  column="id"></id>
		<result property="user.id" column="user.id" />
        <result property="house.id" column="house.id" />
        <result property="appraisetime" column="appraisetime" />
        <result property="house.name" column="house.name" />
        <result property="house.housespic" column="house.housespic" />
        <result property="content" column="content" />
        <result property="status" column="status" />
        <result property="type" column="type" />
        <result property="pricestar" column="pricestar" />
        <result property="placestar" column="placestar" />
        <result property="trafficstar" column="trafficstar" />
        <result property="conditionstar" column="conditionstar" />
        <result property="pid" column="pid" />
        <result property="deleted" column="deleted" />
        
		<collection property="replyList"  ofType="InteractionAppraiseRecord" >
			<id property="id" column="replyList.id"></id>
			<id property="pid" column="replyList.pid"></id>
			<result property="user.id" column="replyList.user.id" />
	        <result property="house.id" column="replyList.house.id" />
	        <result property="user.username" column="replyList.user.username" />
	        <result property="appraisetime" column="replyList.appraisetime" />
	        <result property="content" column="replyList.content" />
	        <result property="status" column="replyList.status" />
	        <result property="type" column="replyList.type" />
	        <result property="pricestar" column="replyList.pricestar" />
	        <result property="placestar" column="replyList.placestar" />
	        <result property="trafficstar" column="replyList.trafficstar" />
	        <result property="conditionstar" column="replyList.conditionstar" />
	        <result property="deleted" column="replyList.deleted" />
		</collection>
	</resultMap>
	
	<sql id="interactionAppraiseRecordColumns">
		T.id AS "id",
		T.appraiseuser AS "user.id",
		T.housesid AS "house.id",
		user.username AS "user.username",
		house.name AS "house.name",
		house.housespic AS "house.housespic",
		T.appraisetime AS "appraisetime",
		T.content AS "content",
		T.status AS "status",
		T.type AS "type",
		T.placestar AS "placestar",
		T.trafficstar AS "trafficstar",
		T.conditionstar AS "conditionstar",
		T.pid AS "pid",
		T.pricestar AS "pricestar",
		T.deleted AS "deleted"
	</sql>
	
	<!-- 自关联的表要用到的sql，不然好像是会冲突？同上面一个sql字段区别，不然updateStatus会出问题 -->
	<sql id="interactionAppraiseRecordSelfColumns">
		T.id AS "id",
		T.appraiseuser AS "user.id",
		T.housesid AS "house.id",
		user.username AS "user.username",
		house.name AS "house.name",
		house.housespic AS "house.housespic",
		T.appraisetime AS "appraisetime",
		T.content AS "content",
		T.status AS "status",
		T.type AS "type",
		T.placestar AS "placestar",
		T.trafficstar AS "trafficstar",
		T.conditionstar AS "conditionstar",
		T.pid AS "pid",
		T.pricestar AS "pricestar",
		T.deleted AS "deleted",		
		
		A.content AS "replyList.content",
		A.appraisetime AS "replyList.appraisetime",
		user.username AS "replyList.user.username",
		A.appraiseuser AS "replyList.user.id"
<!-- 		A.housesid AS "replyList.house.id", -->
<!-- 		A.status AS "replyList.status", -->
<!-- 		A.placestar AS "replyList.placestar", -->
<!-- 		A.trafficstar AS "replyList.trafficstar", -->
<!-- 		A.conditionstar AS "replyList.conditionstar", -->
<!-- 		A.pid AS "replyList.pid", -->
<!-- 		A.appraiseuser AS "replyList.user.id", -->
<!-- 		A.type AS "replyList.type",  -->
<!-- 		A.pricestar AS "replyList.pricestar", -->
<!-- 		A.deleted AS "replyList.deleted"	 -->
	</sql>
	
	<sql id="interactionAppraiseRecordJoins">
	LEFT JOIN user_info user ON user.id = T.appraiseuser
	LEFT JOIN houses_info house ON house.id =T.housesid
	</sql>
	
	<sql id="interactionAppraiseRecordSelfJoins">
	LEFT JOIN user_info user ON user.id = T.appraiseuser
	LEFT JOIN houses_info house ON house.id =T.housesid
	LEFT JOIN interaction_appraise_record A ON A.pid =T.id
	</sql>
    
	<select id="getById" resultType="InteractionAppraiseRecord">
		SELECT 
			<include refid="interactionAppraiseRecordColumns"/>
		FROM interaction_appraise_record T
		<include refid="interactionAppraiseRecordJoins"/>
		WHERE T.id = #{id}
	</select>
	
<!-- 查询回复记录 -->
	<select id="selectReply" resultMap="appraiseReply">
		SELECT 
			<include refid="interactionAppraiseRecordSelfColumns"/>
		FROM interaction_appraise_record T
			<include refid="interactionAppraiseRecordSelfJoins"/>
			<if test="condition!=null">
				<where>
					<if test="condition.model!=null">
						<if test="condition.model.content!=null and condition.model.content!=''">
							AND	T.content LIKE '${condition.model.content}%'
						</if>
						<if test="condition.model.status != null">
							AND	T.status = #{condition.model.status}
						</if>
					</if>
					<if test="condition.appraiseuserid != null and condition.appraiseuserid != ''">
						AND T.appraiseuser = #{condition.appraiseuserid} AND T.pid is null
					</if> 
				</where>
			</if>
		order by T.ID DESC, A.ID ASC
		<include refid="Sql.pager" />
	</select>
	
	<select id="findListByPage" resultType="InteractionAppraiseRecord">
		SELECT 
			<include refid="interactionAppraiseRecordColumns"/>
		FROM interaction_appraise_record T 
		<include refid="interactionAppraiseRecordJoins"/>
		<if test="condition!=null">
			<where>
				<if test="condition.model!=null">
					<if test="condition.model.content!=null and condition.model.content!=''">
						AND	T.content LIKE '${condition.model.content}%'
					</if>
					<if test="condition.model.status != null">
						AND	T.status = #{condition.model.status}
					</if>
				</if>
				<if test="condition.appraiseuserid != null and condition.appraiseuserid != ''">
					AND T.appraiseuser = #{condition.appraiseuserid} AND T.pid is null
				</if> 
			</where>
			order by T.ID DESC
			<include refid="Sql.pager" />
		</if>
	</select>
	
<!-- 	根据当前用户id获得该用户的的站内信总数	 -->
	<select id="getCountByCurrentUserId" resultType="int">
		SELECT 
			count(*)
		FROM interaction_appraise_record T 
		<include refid="interactionAppraiseRecordJoins"/>
			<if test="condition!=null">
				<where>
					AND T.appraiseuser = #{condition.appraiseuserid} AND T.pid is null
				</where>
			</if>
	</select>	
	
	<select id="getByCurrentId" resultType="InteractionAppraiseRecord">
		SELECT 
			<include refid="interactionAppraiseRecordColumns"/>
		FROM interaction_appraise_record T 
		<include refid="interactionAppraiseRecordJoins"/>
		<if test="condition!=null">
			<where>
				T.appraiseuser = #{condition.appraiseuserid} AND T.pid is null
				<if test="condition.model!=null">
					<if test="condition.model.content!=null and condition.model.content!=''">
						AND	T.content LIKE '${condition.model.content}%'
					</if>
					<if test="condition.model.status!=null">
						AND	T.status = #{condition.model.status}
					</if>
				</if>
			</where>
			order by T.ID DESC
			<include refid="Sql.pager" />
		</if>
	</select>
	
	<select id="getCountByCondition" resultType="int">
		SELECT 
			count(*)
		FROM interaction_appraise_record T
		<include refid="interactionAppraiseRecordJoins"/>
		<if test="condition!=null">
			<where>
				<if test="condition.model!=null">
					<if test="condition.model.content!=null and condition.model.content!=''">
						AND	T.content LIKE '${condition.model.content}%'
					</if>
					<if test="condition.model.status != null">
						AND	T.status = #{condition.model.status}
					</if>
				</if>
				<if test="condition.appraiseuserid != null and condition.appraiseuserid != ''">
					AND T.appraiseuser = #{condition.appraiseuserid} AND T.pid is null
				</if> 
			</where>
		</if>
	</select>
	
	<select id="findAllList" resultType="InteractionAppraiseRecord">
		SELECT 
			<include refid="interactionAppraiseRecordColumns"/>
		FROM interaction_appraise_record T
		<include refid="interactionAppraiseRecordJoins"/>
		<where>
			<if test="condition!=null">
				<if test="condition.model!=null">
					<if test="condition.model.content!=null and condition.model.content!=''">
						T.content LIKE '${condition.model.content}%'
					</if>
				</if>
			</if>
		</where>		
	</select>
	
	<insert id="insert">
		INSERT INTO interaction_appraise_record(
			appraiseuser,
			housesid,
			appraisetime,
			content,
			status,
			type,
			pricestar,
			placestar,
			trafficstar,
			conditionstar,
			pid,
			deleted
		) VALUES (
			#{user.id},
			#{house.id},
			#{appraisetime},
			#{content},
			#{status},
			#{type},
			#{pricestar},
			#{placestar},
			#{trafficstar},
			#{conditionstar},
			#{pid},
			#{deleted}
		)
		<!-- 配置Mysql主键自动增长 -->
		<selectKey resultType="int" keyProperty="id">
			select
			LAST_INSERT_ID() as value  
		</selectKey>
	</insert>
	
<!-- 	<update id="update"> -->
<!-- 		UPDATE interaction_appraise_record -->
<!-- 		<set> -->
<!-- 				<if test="appraiseuser !=null"> -->
<!-- 				T.appraiseuser = #{user.id}, -->
<!-- 			</if> -->
<!-- 			<if test="housesid != null"> -->
<!-- 				T.housesid = #{house.id}, -->
<!-- 			</if> -->
<!-- 			<if test="appraisetime != null"> -->
<!-- 				T.appraisetime = #{appraisetime}, -->
<!-- 			</if> -->
<!-- 			<if test="content !=null"> -->
<!-- 				T.content = #{content}, -->
<!-- 			</if> -->
<!-- 			<if test="type != null"> -->
<!-- 				T.type = #{type}, -->
<!-- 			</if> -->
<!-- 			<if test="placestar != null"> -->
<!-- 				T.placestar = #{placestar}, -->
<!-- 			</if> -->
<!-- 			<if test="trafficstar != null"> -->
<!-- 				T.trafficstar = #{trafficstar}, -->
<!-- 			</if> -->
<!-- 			<if test="conditionstar != null"> -->
<!-- 				T.conditionstar = #{conditionstar}, -->
<!-- 			</if> -->
<!-- 			<if test="pid != null"> -->
<!-- 				T.pid = #{pid}, -->
<!-- 			</if> -->
<!-- 			<if test="pricestar != null"> -->
<!-- 				T.pricestar = #{pricestar}, -->
<!-- 			</if> -->
<!-- 			<if test="deleted != null"> -->
<!-- 				T.deleted = #{deleted}, -->
<!-- 			</if> -->
<!-- 		</set> -->
<!-- 		WHERE id = #{id} -->
<!-- 	</update> -->
	
	<update id="updateStatus">
		UPDATE interaction_appraise_record 
		<set>
			<if test="optionMark != null">
				status = #{optionMark},
			</if>
		</set>
		WHERE id = #{id}
	</update>
	
	
	<update id="deleteById">
		update interaction_appraise_record set 
			deleted=1
		WHERE id = #{id}
	</update>
	
</mapper>